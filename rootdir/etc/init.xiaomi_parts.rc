#
# Copyright 2020 Paranoid Android
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

on boot
# XiaomiParts
    chown system system /sys/devices/virtual/timed_output/vibrator/vtg_level
    chmod 0660 /sys/devices/virtual/timed_output/vibrator/vtg_level
    chown system system /sys/module/hall/parameters/hall_toggle
    chmod 0660 /sys/module/hall/parameters/hall_toggle
	
# Thermal Configs
    chown system /sys/devices/virtual/thermal/thermal_message/sconfig
	chmod 0660 /sys/devices/virtual/thermal/thermal_message/sconfig

# Backlight dimmer
    chown system /sys/class/leds/while/max_brightness
	chmod 0660 /sys/class/leds/while/max_brightness

# FPS INFO 
    chown system graphics /sys/module/primary_display/parameters/display_framerate_main
    chmod 0666 /sys/module/primary_display/parameters/display_framerate_main 
    chown system graphics /sys/module/primary_display/parameters/display_framerate_ext
	chmod 0666 /sys/module/primary_display/parameters/display_framerate_ext


service folio_daemon /system/bin/folio_daemon
    class late_start
    user system
    group system uhid
    disabled
	
service mi_thermald /system/vendor/bin/mi_thermald
    class main
    user root
    group system
    seclabel u:r:mi_thermald:s0

on property:persist.service.folio_daemon=0
    stop folio_daemon

on property:persist.service.folio_daemon=1
    start folio_daemon
    
# Initialization
on property:sys.boot_completed=1
    setprop spectrum.support 1
    # chown
    chown system system /sys/devices/system/cpu/cpufreq/policy0/*
    chown system system /sys/devices/system/cpu/cpufreq/policy6/*
    chown system system /sys/block/mmcblk0/queue/*
    chown system system /sys/block/sda/queue/*
    chown system system /sys/block/sdb/queue/*
    chown system system /sys/block/sdc/queue/*
    # chmod
    chmod 0644 /sys/devices/system/cpu/cpufreq/policy0/*
    chmod 0644 /sys/devices/system/cpu/cpufreq/policy6/*
    chmod 0644 /sys/block/mmcblk0/queue/*
    chmod 0644 /sys/block/sda/queue/*
    chmod 0644 /sys/block/sdb/queue/*
    chmod 0644 /sys/block/sdc/queue/*

    # chown
    chown system system /sys/devices/system/cpu/cpufreq/policy0/*
    chown system system /sys/devices/system/cpu/cpufreq/policy6/*
    chown system system /sys/block/mmcblk0/queue/*
    chown system system /sys/block/sda/queue/*
    chown system system /sys/block/sdb/queue/*
    chown system system /sys/block/sdc/queue/*
    # chmod
    chmod 0644 /sys/devices/system/cpu/cpufreq/policy0/*
    chmod 0644 /sys/devices/system/cpu/cpufreq/policy6/*
    chmod 0644 /sys/block/mmcblk0/queue/*
    chmod 0644 /sys/block/sda/queue/*
    chmod 0644 /sys/block/sdb/queue/*
    chmod 0644 /sys/block/sdc/queue/*
    setprop vendor.post_boot.parsed 1

on property:vendor.post_boot.parsed=1
    setprop sys.display-size 3840x2160
    # for set mode spectrum
    setprop persist.spectrum.profile 0

# Battery
on property:persist.spectrum.profile=2
    # CPU TWEAK
    chmod 0644 /sys/devices/system/cpu/cpufreq/policy0/scaling_governor
    write /sys/devices/system/cpu/cpufreq/policy0/scaling_governor conservative
    chmod 0644 /sys/devices/system/cpu/cpufreq/policy6/scaling_governor
    write /sys/devices/system/cpu/cpufreq/policy6/scaling_governor conservative
    restorecon -R /sys/devices/system/cpu
    chown system system /sys/devices/system/cpu/cpufreq/conservative/*
    chmod 0644 /sys/devices/system/cpu/cpufreq/conservative/*
    write /sys/devices/system/cpu/cpufreq/conservative/up_threshold "60"
    write /sys/devices/system/cpu/cpufreq/conservative/sampling_rate "150000"
    write /sys/devices/system/cpu/cpufreq/conservative/sampling_down_factor "1"
    write /sys/devices/system/cpu/cpufreq/conservative/down_threshold "40"
    write /sys/devices/system/cpu/cpufreq/conservative/freq_step "10"
    # scheduler TWEAK
    write /sys/block/mmcblk0/queue/scheduler cfq
    write /sys/block/sda/queue/scheduler cfq
    write /sys/block/sdb/queue/scheduler cfq
    write /sys/block/sdc/queue/scheduler cfq
	start mi_thermald
    
# balance
on property:persist.spectrum.profile=0
    # CPU TWEAK
    chmod 0644 /sys/devices/system/cpu/cpufreq/policy0/scaling_governor
    write /sys/devices/system/cpu/cpufreq/policy0/scaling_governor schedutil
    chmod 0644 /sys/devices/system/cpu/cpufreq/policy6/scaling_governor
    write /sys/devices/system/cpu/cpufreq/policy6/scaling_governor schedutil
    restorecon -R /sys/devices/system/cpu
    chown system system /sys/devices/system/cpu/cpufreq/schedutil/*
    chmod 0644 /sys/devices/system/cpu/cpufreq/schedutil/*
    write /sys/devices/system/cpu/cpufreq/schedutil/down_rate_limit_us "90000"
    write /sys/devices/system/cpu/cpufreq/schedutil/up_rate_limit_us "500"
    # scheduler TWEAK
    write /sys/block/mmcblk0/queue/scheduler deadline
    write /sys/block/sda/queue/scheduler deadline
    write /sys/block/sdb/queue/scheduler deadline
    write /sys/block/sdc/queue/scheduler deadline
	stop mi_thermald
    
# Gaming
on property:persist.spectrum.profile=3
    setenforce 0
# Governor parameters
chmod 0644 /sys/devices/system/cpu/cpufreq/policy0/scaling_governor
echo "performance" > /sys/devices/system/cpu/cpufreq/policy0/scaling_governor
chmod 0644 /sys/devices/system/cpu/cpufreq/policy6/scaling_governor
echo "performance" > /sys/devices/system/cpu/cpufreq/policy6/scaling_governor

# Devfreq and GPU
echo "1" > /proc/mali/always_on
echo "0" > /proc/mali/dvfs_enable
echo "always_on" > /sys/devices/platform/13040000.mali/power_policy
echo "806000" > /proc/gpufreq/gpufreq_opp_freq

# CPU Input Boost
echo "1" > /sys/module/cpu_input_boost/parameters/enabled
echo "2050000" > /sys/module/cpu_input_boost/parameters/idle_freq_hp
echo "2000000" > /sys/module/cpu_input_boost/parameters/idle_freq_lp
echo "50" > /sys/module/cpu_input_boost/parameters/input_boost_duration
echo "2050000" > /sys/module/cpu_input_boost/parameters/input_boost_freq_hp 
echo "2000000" > /sys/module/cpu_input_boost/parameters/input_boost_freq_lp
echo "Y" > /sys/module/cpu_input_boost/parameters/lock_max_freq
echo "2050000" > /sys/module/cpu_input_boost/parameters/max_boost_freq_hp
echo "2000000" > /sys/module/cpu_input_boost/parameters/max_boost_freq_lp
echo "2050000" > /sys/module/cpu_input_boost/parameters/min_freq_hp
echo "2000000" > /sys/module/cpu_input_boost/parameters/min_freq_lp
echo "1000" > /sys/module/cpu_input_boost/parameters/wake_boost_duration

# PPM status
echo "1" > /proc/ppm/enabled
echo "2 1" > /proc/ppm/policy_status
echo "3 0" > /proc/ppm/policy_status
echo "4 0" > /proc/ppm/policy_status
echo "5 0" > /proc/ppm/policy_status
echo "0 0" > /proc/ppm/policy/ut_fix_freq_idx
# PPM Big cluster
echo "1 2050000" > /proc/ppm/policy/hard_userlimit_max_cpu_freq
echo "1 2050000" > /proc/ppm/policy/hard_userlimit_min_cpu_freq
# PPM Little cluster
echo "0 2000000" > /proc/ppm/policy/hard_userlimit_max_cpu_freq
echo "0 2000000" > /proc/ppm/policy/hard_userlimit_min_cpu_freq
# MTK PPM boost
echo "Y" > /sys/module/mtk_ppm_policy_sys_boost/parameters/ppm_sysboost_policy_status

# Workqueue
echo "N" > /sys/module/workqueue/parameters/power_efficient
echo "N" > /sys/module/battery_saver/parameters/enabled
echo "N" > /sys/module/workqueue/parameters/disable_numa

# Schedtune
echo "0" > /dev/stune/background/schedtune.boost
echo "0" > /dev/stune/foreground/schedtune.boost
echo "40" > /dev/stune/rt/schedtune.boost
echo "10" > /dev/stune/top-app/schedtune.boost
echo "10" > /dev/stune/schedtune.boost
echo "0" > /dev/stune/nnapi-hal/schedtune.boost
echo "0" > /dev/stune/nnapi-hal/schedtune.prefer_idle
echo "0" > /dev/stune/top-app/schedtune.prefer_idle
echo "0" > /dev/stune/background/schedtune.prefer_idle
echo "0" > /dev/stune/foreground/schedtune.prefer_idle
echo "0" > /dev/stune/rt/schedtune.prefer_idle
echo "0" > /dev/stune/schedtune.prefer_idle
echo "0" > /dev/stune/camera-daemon/schedtune.boost
echo "0" > /dev/stune/camera-daemon/schedtune.prefer_idle

# GED parameters
echo "0" > /sys/module/ged/parameters/gx_dfps
echo "1" > /sys/module/ged/parameters/gx_game_mode
echo "0" > /sys/module/ged/parameters/gx_3D_benchmark_on
echo "1" > /sys/module/ged/parameters/gx_boost_on
echo "1" > /sys/module/ged/parameters/gx_force_cpu_boost
echo "1" > /sys/module/ged/parameters/gx_frc_mode
echo "1" > /sys/module/ged/parameters/cpu_boost_policy
echo "1" > /sys/module/ged/parameters/enable_cpu_boost
echo "1" > /sys/module/ged/parameters/boost_amp
echo "1" > /sys/module/ged/parameters/boost_extra
echo "1" > /sys/module/ged/parameters/enable_gpu_boost
echo "1" > /sys/module/ged/parameters/boost_gpu_enable
echo "0" > /sys/module/ged/parameters/gpu_debug_enable
echo "0" > /sys/module/ged/parameters/gpu_cust_boost_freq
echo "0" > /sys/module/ged/parameters/gpu_idle
echo "1" > /sys/module/ged/parameters/gpu_dvfs_enable
echo "1" > /sys/module/ged/parameters/ged_boost_enable
echo "1" > /sys/module/ged/parameters/ged_force_mdp_enable
echo "0" > /sys/module/ged/parameters/ged_smart_boost
echo "1" > /sys/module/ged/parameters/enable_game_self_frc_detect
echo "1" > /sys/module/ged/parameters/is_GED_KPI_enabled
echo "20000000" > /sys/module/ged/parameters/target_t_cpu_remained

# I/O Scheduler
echo "deadline" > /sys/block/mmcblk0/queue/scheduler
echo "deadline" > /sys/block/sda/queue/scheduler
echo "deadline" > /sys/block/sdb/queue/scheduler
echo "deadline" > /sys/block/sdc/queue/scheduler

echo "0" > /sys/block/mmcblk0/queue/add_random
echo "0" > /sys/block/mmcblk0/queue/iostats
echo "2" > /sys/block/mmcblk0/queue/nomerges
echo "0" > /sys/block/mmcblk0/queue/rotational
echo "2" > /sys/block/mmcblk0/queue/rq_affinity
echo "128" > /sys/block/mmcblk0/queue/nr_requests
echo "128" > /sys/block/mmcblk0/queue/read_ahead_kb

echo "0" > /sys/block/sda/queue/add_random
echo "0" > /sys/block/sda/queue/iostats
echo "2" > /sys/block/sda/queue/nomerges
echo "0" > /sys/block/sda/queue/rotational
echo "2" > /sys/block/sda/queue/rq_affinity
echo "128" > /sys/block/sda/queue/nr_requests
echo "128" > /sys/block/sda/queue/read_ahead_kb

echo "0" > /sys/block/sdb/queue/add_random
echo "0" > /sys/block/sdb/queue/iostats
echo "2" > /sys/block/sdb/queue/nomerges
echo "0" > /sys/block/sdb/queue/rotational
echo "2" > /sys/block/sdb/queue/rq_affinity
echo "128" > /sys/block/sdb/queue/nr_requests
echo "128" > /sys/block/sdb/queue/read_ahead_kb

echo "0" > /sys/block/sdc/queue/add_random
echo "0" > /sys/block/sdc/queue/iostats
echo "2" > /sys/block/sdc/queue/nomerges
echo "0" > /sys/block/sdc/queue/rotational
echo "2" > /sys/block/sdc/queue/rq_affinity
echo "128" > /sys/block/sdc/queue/nr_requests
echo "128" > /sys/block/sdc/queue/read_ahead_kb

# Virtual memory
echo "3000" > /proc/sys/vm/dirty_expire_centisecs
echo "3000" > /proc/sys/vm/dirty_writeback_centisecs
echo "150" > /proc/sys/vm/vfs_cache_pressure
echo "60" > /proc/sys/vm/swappiness
echo "20" > /proc/sys/vm/dirty_ratio
echo "5" > /proc/sys/vm/dirty_background_ratio 
echo "0" > /proc/sys/vm/laptop_mode
echo "0" > /proc/sys/vm/page-cluster
echo "1" > /proc/sys/vm/overcommit_memory
echo "100" > /proc/sys/vm/overcommit_ratio
echo "20" > /proc/sys/vm/stat_interval
echo "3" > /proc/sys/vm/drop_caches

# Misc
echo "0" > /proc/sys/kernel/panic
echo "0" > /proc/sys/kernel/panic_on_oops
echo "0" > /proc/sys/kernel/panic_on_warn
echo "0 0 0 0" > /proc/sys/kernel/printk
echo "off" > /proc/sys/kernel/printk_devkmsg
echo "0" > /sys/module/kernel/parameters/panic
echo "0" > /sys/module/kernel/parameters/pause_on_oops
echo "0" > /sys/module/kernel/parameters/panic_on_warn
echo "100"  > /sys/module/fbt_cpu/parameters/bhr
echo "15" > /sys/module/fbt_cpu/parameters/bhr_opp
echo "20" > /sys/module/fbt_cpu/parameters/floor_bound
echo "61" > /sys/module/fbt_cpu/parameters/fps_level_range
echo "100" > /sys/module/fbt_cpu/parameters/variance

echo "com.miHoYo.,com.tencent.,UnityMain,libunity.so" > /proc/sys/kernel/sched_lib_name
echo "255" > /proc/sys/kernel/sched_lib_mask_force
echo "0" > /proc/sys/kernel/sched_migration_cost_ns
echo "50000" > /proc/sys/kernel/threads-max
echo "20" > /proc/sys/kernel/perf_cpu_time_max_percent

# Thermal
stop mi_thermald
stop thermal
stop thermald
stop thermalloadalgod
stop thermal_manager
setprop init.svc.thermal_manager stopped
setprop init.svc.vendor.thermal-hal-2-0.mtk stopped

setenforce 1


# Performance
on property:persist.spectrum.profile=1
# CPU TWEAK
    chmod 0644 /sys/devices/system/cpu/cpufreq/policy0/scaling_governor
    write /sys/devices/system/cpu/cpufreq/policy0/scaling_governor interactive
    chmod 0644 /sys/devices/system/cpu/cpufreq/policy6/scaling_governor
    write /sys/devices/system/cpu/cpufreq/policy6/scaling_governor interactive
    restorecon -R /sys/devices/system/cpu
    chown system system /sys/devices/system/cpu/cpufreq/interactive/*
    chmod 0644 /sys/devices/system/cpu/cpufreq/interactive/*
    write /sys/devices/system/cpu/cpufreq/policy6/interactive/target_loads "70"
    write /sys/devices/system/cpu/cpufreq/policy6/interactive/above_hispeed_delay "50000"
    write /sys/devices/system/cpu/cpufreq/policy6/interactive/hispeed_freq 2000000
    write /sys/devices/system/cpu/cpufreq/policy6/interactive/go_hispeed_load 80
    write /sys/devices/system/cpu/cpufreq/policy6/interactive/min_sample_time "40000"
    write /sys/devices/system/cpu/cpufreq/policy6/interactive/timer_rate "20000"
    write /sys/devices/system/cpu/cpufreq/policy6/interactive/timer_slack "20000"
    write /sys/devices/system/cpu/cpufreq/policy6/interactive/boostpulse_duration "90000"
    # scheduler TWEAK
    write /sys/block/mmcblk0/queue/scheduler deadline
    write /sys/block/sda/queue/scheduler deadline
    write /sys/block/sdb/queue/scheduler deadline
    write /sys/block/sdc/queue/scheduler deadline